<?php 
    // Database connection
    include ('config.php');

    $showAlert = false; // Initialize showAlert to false

    // Delete code
    if (isset($_POST["delete"])) {
        $deleteTimetableID = $_POST["delete"];
        $sqlDeleteRecord = $mysqli->prepare("DELETE FROM timetable WHERE timetable_id=?");
        $sqlDeleteRecord->bind_param('s', $deleteTimetableID);
        $sqlDeleteRecord->execute();
        $sqlDeleteRecord->close();
        
        echo "<script>alert('Record deleted successfully.')</script>";
        header("refresh:1;url=edittimeslot.php");
    }





if(isset($_POST["submitSave"])){		

	foreach ($_POST['timetable_id'] as $key => $timetable_id) {
		$start_time = $_POST['start_time'][$key];
		$end_time = $_POST['end_time'][$key];
		$day = $_POST['day'][$key];
		$classtype = $_POST['classtype'][$key];
		$subID = $_POST['subID'][$key];
		$venueID = $_POST['venueID'][$key];
		$cstatus = $_POST['cstatus'][$key];
		$hours = $_POST['hours'][$key];

		// Update record
		$sqlUpdateRecord = $mysqli->prepare("UPDATE timetable SET start_time=?, end_time=?, day=?, classtype=?, subID=?, venueID=?, cstatus=?, hours=? WHERE timetable_id=?");
		$sqlUpdateRecord->bind_param('ssssssssi', $start_time, $end_time, $day, $classtype, $subID, $venueID, $cstatus, $hours, $timetable_id);
		$sqlUpdateRecord->execute();
		$sqlUpdateRecord->close();
	}

	header("refresh:1;url=edittimeslot.php");
	echo "<script>alert('Data is successfully saved.')</script>";	
}

if (isset($_POST["reassign"])) {
    // Get distinct lecturer IDs
    $sqlDistinctLecturers = "SELECT DISTINCT lec_id FROM timetable";
    $resultDistinctLecturers = $mysqli->query($sqlDistinctLecturers);
    $lecturerIDs = [];

    while ($row = $resultDistinctLecturers->fetch_assoc()) {
        $lecturerIDs[] = $row['lec_id'];
    }

    // Function to reassign timeslots for a specific lecturer
    function reassignTimeslots($lecID) {
        global $mysqli;

        $sqlExistingTimeslots = "SELECT * FROM timetable WHERE lec_id = ?";
        $stmtExistingTimeslots = $mysqli->prepare($sqlExistingTimeslots);
        $stmtExistingTimeslots->bind_param('s', $lecID);
        $stmtExistingTimeslots->execute();
        $resultExistingTimeslots = $stmtExistingTimeslots->get_result();

        $newTimeslots = [];

        while ($row = $resultExistingTimeslots->fetch_assoc()) {
            // Get the class duration (hours) from the database
            $classDuration = $row['hours'];

            // Generate a random hour between 8 and 15 for the start time
            $randomHour = rand(8, 15);

            // Calculate end time based on class duration
            $newStartTime = sprintf("%02d:%02d:%02d", $randomHour, 0, 0);
            $newEndTime = date("H:i:s", strtotime($newStartTime) + ($classDuration * 60 * 60));

            // Check for clashes with existing timeslots
            $clashExists = false;

            foreach ($newTimeslots as $existingTimeslot) {
                if (($newStartTime >= $existingTimeslot['start_time'] && $newStartTime < $existingTimeslot['end_time']) ||
                    ($newEndTime > $existingTimeslot['start_time'] && $newEndTime <= $existingTimeslot['end_time'])) {
                    $clashExists = true;
                    break;
                }
            }

            if (!$clashExists) {
                $newTimeslots[] = [
                    'start_time' => $newStartTime,
                    'end_time' => $newEndTime
                ];

                // Update timeslot in the database
                $sqlUpdateTimeslot = "UPDATE timetable SET start_time = ?, end_time = ? WHERE timetable_id = ?";
                $stmtUpdateTimeslot = $mysqli->prepare($sqlUpdateTimeslot);
                $stmtUpdateTimeslot->bind_param('sss', $newStartTime, $newEndTime, $row['timetable_id']);
                $stmtUpdateTimeslot->execute();
                $stmtUpdateTimeslot->close();
            }
        }
    }

    // Loop through lecturers and reassign timeslots
    foreach ($lecturerIDs as $lecturerID) {
        reassignTimeslots($lecturerID);
    }

    // Refresh the page after reassignment
    header("refresh:1;url=edittimeslot.php");
    echo "<script>alert('Timeslots reassigned successfully.')</script>";
}


?>


<!DOCTYPE html>
<html>
<head>
	<title>Edit Timetable</title>
</head>
<body>
	<h2>Edit Timetable</h2>

	<table id="myTable">
		<thead>
        <tr >
                    <th>#</th>
                    <th>Timetable ID</th>
                    <th>Lecturer ID</th>
                    <th>Lecturer name</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Day</th>
                    <th>Class Type</th>
                    <th>Sub ID</th>
                    <th>Venue ID</th>
                    <th>Class Status</th>
                    <th>hours</th>
                    <th>Actions</th>
                </tr>
		<form method="post" name="updateTimetable" action="edittimeslot.php">
			<?php
				 $sqlTimetable = "SELECT timetable.*, lecturer.lecname, lecturer.maxhours 
                 FROM timetable
                 INNER JOIN lecturer ON timetable.lec_id = lecturer.lec_id
                 ORDER BY timetable.lec_id, FIELD(LOWER(day), 'monday', 'tuesday', 'wednesday', 'thursday', 'friday');";
				$resultTimetable = $mysqli->query($sqlTimetable);
				$no = 1;
				while ($row = $resultTimetable->fetch_assoc()) {
					$timetable_id = $row["timetable_id"];
                    $lecID = $row["lec_id"];
                    $lecName = $row["lecname"];
					$start_time = $row["start_time"];
					$end_time = $row["end_time"];
					$day = $row["day"];
					$classtype = $row["classtype"];
					$subID = $row["subID"];
					$venueID = $row["venueID"];
					$cstatus = $row["cstatus"];
					$hours = $row["hours"];
                    $totalHoursOfClass = 0;
			?>
			<tr>
				<td><?php echo $no ?></td>
				<td><?php echo $timetable_id ?></td>
				<input type="hidden" name="timetable_id[]" value="<?php echo $timetable_id ?>">
                <td><?php echo $lecID ?></td>
                    <td><?php echo $lecName ?></td>
				<td><input type="time" name="start_time[]" value="<?php echo $start_time ?>"></td>
				<td><input type="time" name="end_time[]" value="<?php echo $end_time ?>"></td>
				<td><input type="text" name="day[]" value="<?php echo $day ?>"></td>
				<td><input type="text" name="classtype[]" value="<?php echo $classtype ?>"></td>
				<td><input type="text" name="subID[]" value="<?php echo $subID ?>"></td>
				<td><input type="text" name="venueID[]" value="<?php echo $venueID ?>"></td>
				<td><input type="text" name="cstatus[]" value="<?php echo $cstatus ?>"></td>
				<td><input type="number" name="hours[]" value="<?php echo $hours ?>"></td>
			</tr>
			<?php
				$no++;
				}
			?>
		</table>
		<br>
		<button name="submitSave" class="button">Save</button>
	</form>
</body>
</html>
